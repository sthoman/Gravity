<script type="text/javascript" src="lib/jquery-1.5.2.min.js" ></script>
<script type="text/javascript">

    var context;

    var dx;// = 1.5;
    var dy;// = 0;
	
	var posx;
	var posy; 

	var initialx = 1.5; 
	var initialy = 0; 
	
	var initialposx = 50;
	var initialposy = 450;
	
   // var posx = 50;
   // var posy = 450;
	
	var _gconstant = 6.674 * Math.pow(10, -11); 
	
	var interval = 20; 

   var Starsystem = new function Starsystem() 
   {
	var instance = this;

	Starsystem.Instance = function()
	{
	    if (_acceleration == null)
			instance.update(); 
			
		return instance; 
	}

	this.stars = new Object(); 

	this.getStars = function() {
		return this.stars; 	
	}
	
	this.nearestStar = function(x, y) {
	
		var closestStarKey = null; 
		
		for (var key in this.stars)
		{		
			var star = this.stars[key]; 
			var closestStar; 
			
			if (closestStarKey == null)
				closestStar = star; 	
			else
				closestStar = this.stars[closestStarKey]
			
			var dist = star.radialDistanceFrom(x, y); 		
			var closestDist = closestStar.radialDistanceFrom(x, y); 			
			if (dist <= closestDist)
				closestStarKey = key; 
		}		
		
		return closestStarKey; 	
	}

	this.add = function(key, val) {
		this.stars[key] = val; 
	}
 
	this.replace = function(key, val) {
		delete this.stars[key];
		this.stars[key] = val; 
	}

	this.remove = function(key) {
		delete this.stars[key];
	}
	
	this.update = function() {	
		_acceleration = getAcceleration(this.stars); 	
	};
	
	var _acceleration; 	
	this.acceleration = function(xpos, ypos) {
		return _acceleration(xpos, ypos); 
	}
	
	var getAcceleration = function (thestars) {

        	return function (xpos, ypos) {

					var dx_total = 0; 
					var dy_total = 0; 
					
					for (var key in thestars)
					{					
						var star = thestars[key]; 
						
						var sep_x = star.XPos - xpos; 
						var sep_y = star.YPos - ypos; 
						
						var _xSqrd = Math.pow(sep_x, 2);
						var _ySqrd = Math.pow(sep_y, 2);

						var radialDist = Math.sqrt(_xSqrd + _ySqrd);
						
						if (radialDist < (star.Radius * 1.05)) {
							//alert("Collision!");	
							start(initialx, initialy); 
						}	
						
						var gravityAt = star.gravitationAt(radialDist)				
						
						var _dx = (gravityAt * sep_x) / Math.pow(radialDist, 1);
						var _dy = (gravityAt * sep_y) / Math.pow(radialDist, 1);

						dx_total += _dx; 
						dy_total += _dy; 
					}
					
					return { dx: dx_total, dy: dy_total }; 
        	}

    	}  //(Star));


		return Starsystem;
    }
	
    function Star(x, y, m, r) {

        this.Mass = m;
        this.Radius = r;
        this.XPos = x;
        this.YPos = y;
		
		//default css color	
		this.Color = "Black"; 

        this.gravitationAt = function (dist) {

            return (_gconstant * this.Mass) / Math.pow(dist, 2);
        }

		this.radialDistanceFrom = function(x, y) {

			var sep_x = this.XPos - x;
        	var sep_y = this.YPos - y;
			
        	var _xSqrd = Math.pow(sep_x, 2);
        	var _ySqrd = Math.pow(sep_y, 2);

        	return Math.sqrt(_xSqrd + _ySqrd);
		}	
    } 

   
	var earthStar; 
	var marsStar; 
	var venusStar; 
	
    //var mass = 18000000000000000;//document.getElementById("txtMass").value;
    //var rad =  32;//document.getElementById("txtRadius").value;
	
    //var earthStar = new Star(450, 450, mass, rad); 
	//var marsStar = new Star(750, 750, mass, rad); 
	//var venusStar = new Star(150, 150, mass, rad);
	
    var theSystem = Starsystem.Instance(); 

	var leapfrogAlternator = true; 
	
    function draw() {
	
		var stars = theSystem.getStars();   
	
        //var accel = theSystem.acceleration(stars); 

        context = myCanvas.getContext('2d');
        context.clearRect(0, 0, 900, 900);
        context.beginPath();
        context.fillStyle = "#0000ff";
        context.arc(posx, posy, 8, 0, Math.PI * 2, true);
        context.closePath();
        context.fill();

		for (var key in stars)
		{
			var star = stars[key];   

			var star_x = star.XPos; 
			var star_y = star.YPos; 
			var star_r = star.Radius; 

			context.beginPath();
			context.fillStyle = star.Color; 
			context.arc(star_x, star_y, star_r, 0, Math.PI * 2, true);
			context.closePath();
			context.fill();
		}

        var a = theSystem.acceleration(posx, posy);
		
		/* TEST ONLY FOR STABLE ORBIT */
		
		//var dist = stars['Earth'].radialDistanceFrom(posx, posy); 
			
		//THIS IS A TEST OF LEAPFROG METHOD
		
		if (leapfrogAlternator == true) // update position only
		{
			posx += dx;
			posy += dy;

			leapfrogAlternator = false; 
		}
		else // update velocity only
		{
			if (posx < 0 || posx > 900) 
			{
				dx = -dx;
			}
			else if (posy < 0 || posy > 900) 
			{
				dy = -dy;
			}
			else
			{
				dx += a.dx;
				dy += a.dy;	
			}
					
			if (Math.abs(dx) > 25 || Math.abs(dy) > 25)
			{
				//alert("collision velocity");
				start(initialx, initialy); 
			}
		
			leapfrogAlternator = true; 
		} 

    }

    // this function finds the mouse position inside the canvas
    function findPos(obj) {
	
        var curleft = 0, curtop = 0;
        if (obj.offsetParent) {
            do {
                curleft += obj.offsetLeft;
                curtop += obj.offsetTop;
            } while (obj = obj.offsetParent);
            return { x: curleft, y: curtop };
        }
        return undefined;
    }

	//TODO: this only works on a single planet system, adjust
	
	// just to apply initial acceleration in the transverse direction
	function getTransverseAcceleration(mag, dist, x, y) {
	
		 //var accel = theSystem.acceleration(theSystem.stars);  	 
		 //var _a = accel(x, y); 	
		 var _a = theSystem.acceleration(x, y); 
		 var _magnitude = Math.sqrt((Math.pow(_a.dx, 2) + Math.pow(_a.dy, 2))); 
		 var _v = (dist * _magnitude);
		 var _normal_dx = _a.dx / _magnitude; 	 
		 var _normal_dy = _a.dy / _magnitude; 		 
		 var _new_dx = _normal_dx * mag; 
		 var _new_dy = _normal_dy * mag; 
		 
		 return { dx: _new_dy, dy: -_new_dx }; 
	}
	
	//DO NOT CHANGE: WORKS FOR STABLE ORBIT (INITIAL VELOCITY)
	function stableOrbit(dist, x, y) {

		 //var accel = theSystem.acceleration(theSystem.stars);  	 
		 //var _a = accel(x, y); 	 
		 var _a = theSystem.acceleration(x, y); 
		 var _magnitude = Math.sqrt((Math.pow(_a.dx, 2) + Math.pow(_a.dy, 2))); 
		 var _v = Math.sqrt(dist * _magnitude);
		 var _normal_dx = _a.dx / _magnitude; 	 
		 var _normal_dy = _a.dy / _magnitude; 		 
		 var _new_vector = { dx: _normal_dy, dy: -_normal_dx }; 		 
		 var _velocityX = _new_vector.dx * _v;  		 
		 var _velocityY = _new_vector.dy * _v;  		

		 return { dx: _velocityX, dy: _velocityY }; 
	}
	
	
	//NOTE: This is set for stable orbit initiation
	var stable; 
	
	function start(x, y) {
	
		var massEarth = document.getElementById("txtMassEarth").value;
		var radiusEarth =  document.getElementById("txtRadiusEarth").value;
		var massMars = document.getElementById("txtMassMars").value;
		var radiusMars =  document.getElementById("txtRadiusMars").value;
		var massVenus = document.getElementById("txtMassVenus").value;
		var radiusVenus =  document.getElementById("txtRadiusVenus").value;
	
		theSystem.stars['Earth'].Mass = massEarth;
        theSystem.stars['Earth'].Radius = radiusEarth;	
		theSystem.stars['Mars'].Mass = massMars;
        theSystem.stars['Mars'].Radius = radiusMars;
		theSystem.stars['Venus'].Mass = massVenus;
        theSystem.stars['Venus'].Radius = radiusVenus;
				
		posx = initialposx;
		posy = initialposy;
		
		restart(x, y); 
	}
	
    function restart(x, y) {  
		
		dx = x; //1.5; 
		dy = y; //0; 
    }
			
	function onSubmitClick() {
		start(initialx, initialy); 
	}
	
	//TODO: Make this work
	function testStable(_posx, _posy)
	{
		theSystem.replace('Mars', new Star(0, 0, 1, 1)); 
		theSystem.replace('Venus', new Star(0, 0, 1, 1)); 
		theSystem.update();
		
		var dist = theSystem.stars['Earth'].radialDistanceFrom(_posx, _posy); 
		
		stable = stableOrbit(dist, _posx, _posy);  
		
		dx = stable.dx; 
		dy = stable.dy; 
		
		alert(dx + ' ' + dy); 
		
		posx = _posx;
		posy = _posy; 

		restart(dx, dy); 
	}

    $(document).ready(function() {
	
		earthStar = new Star(450, 450, 18000000000000, 32); 
		marsStar = new Star(750, 750, 18000000000000, 32); 
		venusStar = new Star(150, 150, 18000000000000, 32); 
		
		earthStar.Color = "Blue";
		marsStar.Color = "Red";
		venusStar.Color = "Orange"; 
		
		theSystem.add("Earth", earthStar); 	
		theSystem.add("Mars", marsStar); 
		theSystem.add("Venus", venusStar); 
		
		var mouseDown = false;
		var inCircle = false;
		
		start(initialx, initialy); 

		$('#myCanvas').mousedown(function (e) {
			mouseDown = true; 
			var pos = findPos(this);
			var x = e.pageX - pos.x;
			var y = e.pageY - pos.y;
			var nearStarName = theSystem.nearestStar(x, y); 
			var nearStar = theSystem.stars[nearStarName]; 
			var radialDist = nearStar.radialDistanceFrom(x, y); 
            if (radialDist < nearStar.Radius) {
                inCircle = true; 
            }
        });

        $('#myCanvas').mouseup(function (e) {
            if (inCircle) { 
                var pos = findPos(this);
                var x = e.pageX - pos.x;
                var y = e.pageY - pos.y;
				var nearStarName = theSystem.nearestStar(x, y);
				var nearStar = theSystem.stars[nearStarName]; 
				var newStar = new Star(x, y, nearStar.Mass, nearStar.Radius); 
				newStar.Color = nearStar.Color; 
				theSystem.replace(nearStarName, newStar); 
				theSystem.update(); 
            }
            mouseDown = false; 
			inCircle = false; 
        });

        $('#myCanvas').mousemove(function (e) {
            if (mouseDown && inCircle) {
                var pos = findPos(this);
                var x = e.pageX - pos.x;
                var y = e.pageY - pos.y;
				var nearStarName = theSystem.nearestStar(x, y); 
				var nearStar = theSystem.stars[nearStarName]; 
				var newStar = new Star(x, y, nearStar.Mass, nearStar.Radius); 
				newStar.Color = nearStar.Color; 
				theSystem.replace(nearStarName, newStar); 
				theSystem.update(); 
            }
        }); 

		setInterval(draw, interval);
    }); 

    //setInterval(draw, 10);

</script>
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>HTML5 Bouncing Ball</title>
<style type="text/css">
body { background-color:#ededed; font:normal 12px/18px Arial, Helvetica, sans-serif; }
h1 { display:block; width:600px; margin:20px auto; padding-bottom:20px; font:normal 24px/30px Georgia, "Times New Roman", Times, serif; color:#333; text-shadow: 1px 2px 3px #ccc; border-bottom:1px solid #cbcbcb; }
#container { width:600px; margin:0 auto; }
#myCanvas { background:#fff; border:1px solid #cbcbcb; }
#nav { display:block; width:100%; text-align:center; }
#nav li { display:block; font-weight:bold; line-height:21px; text-shadow:1px 1px 1px #fff; width:100px; height:21px; padding:5px; margin:0 10px; background:#e0e0e0; border:1px solid #ccc; -moz-border-radius:4px;-webkit-border-radius:4px; border-radius:4px; float:left; }
#nav li a { color:#000; display:block; text-decoration:none; width:100%; height:100%; }
</style>
</head>
<body>

<span>Earth Mass (Blue)</span><input type="text" id="txtMassEarth" value="18000000000000" /><br />
<span>Earth Radius (Blue) </span><input type="text" id="txtRadiusEarth" value="32" /><br />
<span>Mars Mass (Red)</span><input type="text" id="txtMassMars" value="18000000000000" /><br />
<span>Mars Radius (Red) </span><input type="text" id="txtRadiusMars" value="32" /><br />
<span>Venus Mass (Orange)</span><input type="text" id="txtMassVenus" value="18000000000000" /><br />
<span>Venus Radius (Orange) </span><input type="text" id="txtRadiusVenus" value="32" /><br />
<!--<span>Projectile Initial Velocity (X)</span><input type="text" id="txtVelocityX" value="2"  /><br />
<span>Projectile Initial Velocity (Y)</span><input type="text" id="txtVelocityY" value="2"  /><br />-->

<input type="button" id="btnSubmit" value="Restart" onclick="onSubmitClick();" />

<div id="collision"></div>

<div id="container">
<canvas id="myCanvas" style="float:left;" width="900" height="900"></canvas>
<ul id="nav">
</ul>
</div>

</body>
</html>
